<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>slang/emoji translator</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 2em;
      background-color: #fff;
      color: #181818;
      font-size: 1.08em;
      line-height: 1.6;
    }
    .container {
      width: 100%;
      max-width: none;
      margin: 0 auto;
      padding: 0 1em;
      box-sizing: border-box;
    }
    textarea, .output {
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
      padding: 1em;
      border-radius: 0.5em;
      border: 1px solid #bdbdbd;
      margin-bottom: 1em;
      background: #fff;
      color: #181818;
      resize: vertical;
      transition: border 0.2s;
      font-family: system-ui, sans-serif;
    }
    textarea:focus, .output:focus {
      border-color: #ff8300;
      outline: none;
    }
    .output {
      white-space: pre-wrap;
      min-height: 60px;
      margin-bottom: 1em;
      background: #f8f8f8;
      border: 1px solid #d0d0d0;
      font-size: 0.9em;
      color: #333;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
      border-bottom: 1px dashed #666;
      font-size: 1.1em;
      font-weight: 500;
      color: #444;
    }
    .tooltip-explain-box {
      display: none;
      position: absolute;
      background-color: #f5f5f5;
      color: #333;
      text-align: left;
      border-radius: 8px;
      padding: 0.8em 1em;
      z-index: 1000;
      min-width: 180px;
      max-width: 300px;
      font-size: 0.9em;
      border: 1px solid #ccc;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      line-height: 1.4;
      font-family: inherit;
      font-weight: normal;
      word-break: break-word;
      /* å°ä¸‰è§’å½¢æŒ‡ç¤ºå™¨ */
    }
    .tooltip-explain-box::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #f5f5f5;
    }
    .tooltip-explain-box.tooltip-below::after {
      top: -12px;
      border-top-color: transparent;
      border-bottom-color: #f5f5f5;
    }
    .tooltip-explain-box .close-btn {
      position: absolute;
      top: 0.2em;
      right: 0.5em;
      background: none;
      border: none;
      font-size: 1.1em;
      color: #888;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 1.5em;
      height: 1.5em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lang-switch {
      margin-bottom: 1em;
      text-align: right;
    }
    .lang-switch button {
      background: #ff8300;
      border: none;
      color: #fff;
      padding: 0.4em 0.8em;
      font-size: 0.9em;
      font-weight: normal;
      border-radius: 0.3em;
      cursor: pointer;
      transition: background 0.2s;
      letter-spacing: 0.01em;
      box-shadow: none;
    }
    .lang-switch button:hover {
      background: #e86d00;
    }
    form.add-term {
      /* Remove background and shadow */
      padding: 0;
      border-radius: 0;
      margin-top: 1.5em;
      box-shadow: none;
    }
    form.add-term h3 {
      margin-top: 0;
      margin-bottom: 0.5em;
      font-weight: 500;
      color: #181818;
    }
    form.add-term label {
      display: block;
      margin-bottom: 0.3em;
      font-weight: 600;
      color: #444;
      font-size: 0.96em;
    }
    form.add-term input[type="text"] {
      width: 100%;
      padding: 0.5em;
      margin-bottom: 0.8em;
      border: 1px solid #bdbdbd;
      border-radius: 0.4em;
      font-size: 1em;
      box-sizing: border-box;
      background: #fff;
      color: #181818;
      font-family: system-ui, sans-serif;
    }
    form.add-term input[type="text"]:focus {
      border-color: #ff8300;
      outline: none;
    }
    form.add-term button {
      background: #ff8300;
      border: none;
      color: #fff;
      padding: 0.6em 1.3em;
      font-size: 1.05em;
      border-radius: 0.5em;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
      margin-top: 0.1em;
    }
    form.add-term button:hover {
      background: #e86d00;
    }
    .message {
      margin-top: 0.5em;
      font-size: 0.95em;
      color: #1ca51c;
    }

    /* Responsive layout */
    @media (max-width: 700px) {
      .container {
        max-width: 98vw;
        padding: 0 2vw;
      }
      textarea, .output, form.add-term input[type="text"] {
        font-size: 1em;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 0.5em;
        font-size: 1.05em;
      }
      .container {
        padding: 0 1vw;
      }
      textarea, .output, form.add-term input[type="text"] {
        font-size: 1.05em;
        padding: 0.8em;
      }
      .lang-switch button, form.add-term button {
        font-size: 1.05em;
        padding: 0.6em 1.2em;
      }
    }
  </style>
    /* Supabase CDN will be added below */
</head>
<body>
  <div class="container">
    <h2 id="mainTitle">ç½‘ç»œè¯­/Emoji è§£é‡Šå™¨</h2>
    <div class="lang-switch">
      <button id="langBtn">English</button>
    </div>
    <textarea id="input" placeholder="è¾“å…¥ç½‘ç»œè¯­å¥ï¼Œæ¯”å¦‚ï¼šä»Šå¤©çœŸæ˜¯å¤ªemoäº†ğŸ˜­ï¼"></textarea>
    <button id="explainBtn" onclick="translateText()" style="background:#ff8300;color:#fff;font-size:1.18em;font-weight:bold;padding:0.8em 2em;border-radius:0.6em;border:none;cursor:pointer;transition:all 0.2s;box-shadow:none;margin-bottom:0.7em;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'" onmouseover="this.style.background='#e86d00'" onmouseout="this.style.background='#ff8300'">è§£é‡Šç½‘ç»œè¯­</button>
    <h3 id="resultTitle">ç¿»è¯‘ç»“æœï¼š</h3>
    <div class="output" id="output"></div>
    <form class="add-term" id="addTermForm">
      <h3 id="addTermTitle">æ·»åŠ æ–°è¯æ¡</h3>
      <label id="labelNewTerm" for="newTerm">æ–°è¯è¯­ (è¯è¯­/ç¬¦å·):</label>
      <input type="text" id="newTerm" placeholder="ä¾‹å¦‚ï¼šğŸ˜‚" required>
      <label id="labelZh" for="newExplanationZh">ä¸­æ–‡è§£é‡Š:</label>
      <input type="text" id="newExplanationZh" placeholder="ä¾‹å¦‚ï¼šç¬‘åˆ°å“­" required>
      <label id="labelEn" for="newExplanationEn">è‹±æ–‡è§£é‡Š:</label>
      <input type="text" id="newExplanationEn" placeholder="ä¾‹å¦‚ï¼šLaughing until crying" required>
      <button type="submit" id="addTermBtn">æ·»åŠ è¯æ¡</button>
      <div class="message" id="addTermMessage"></div>
    </form>
  </div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let currentLang = 'zh'; // 'zh' or 'en'

    // slangDict will be loaded from Supabase if present
    let slangDict = {
      "ğŸ˜­": { zh: "ä¼¤å¿ƒæˆ–ç¬‘åˆ°å“­", en: "Sad or laughing until crying" },
      "ğŸ’…": { zh: "è‡ªä¿¡ã€ä¸åœ¨ä¹ä»–äººçœ‹æ³•", en: "Confident, don't care about others' opinions" },
      "ğŸ˜ˆ": { zh: "æ·˜æ°”ã€è°ƒçš®æˆ–æœ‰ç‚¹å", en: "Naughty, mischievous or a bit bad" },
      "ğŸ’€": { zh: "ç¬‘æ­»ã€éå¸¸æç¬‘", en: "Laughing to death, very funny" },
      "ğŸ’©": { zh: "è¡¨ç¤ºç³Ÿç³•ã€å¥‡æ€ªæˆ–æç¬‘", en: "Indicates bad, weird, or funny" },
      "ğŸ¤¡": { zh: "å°ä¸‘ã€å˜²è®½è‡ªå·±æˆ–ä»–äºº", en: "Clown, mocking oneself or others" },
      "ğŸ¥¶": { zh: "å†·ã€éœ‡æƒŠæˆ–æ— è¯­", en: "Cold, shocked or speechless" },
      "ğŸ‘»": { zh: "é¬¼æ‰ã€ç¥æ“ä½œ", en: "Genius, amazing operation" },
      "ğŸ¤—": { zh: "ç»™ä½ ä¸ªæ‹¥æŠ±", en: "Give you a hug" },
      "ğŸ™ƒ": { zh: "æ— å¥ˆã€åè®½", en: "Helpless, ironic" },
      "emo": { zh: "æƒ…ç»ªä½è½ã€å¿ƒæƒ…ä¸å¥½", en: "Feeling down or in a bad mood" },
      "å†…å·": { zh: "å¤§å®¶éƒ½åœ¨æ¿€çƒˆç«äº‰ï¼Œå‹åŠ›å¤§", en: "Everyone is in fierce competition, high pressure" },
      "èººå¹³": { zh: "ä¸æƒ³åŠªåŠ›ï¼Œé€‰æ‹©æ‘†çƒ‚", en: "Don't want to work hard, choose to slack off" },
      "æ‘†çƒ‚": { zh: "ç ´ç½å­ç ´æ‘”ï¼Œä¸åŠªåŠ›äº†", en: "Give up trying, stop making effort" },
      "ç¤¾æ­»": { zh: "ç¤¾äº¤ä¸Šå°´å°¬åˆ°æƒ³éšèº«", en: "Socially embarrassed to want to disappear" },
      "ç ´é˜²": { zh: "å¿ƒç†é˜²çº¿è¢«æ”»ç ´", en: "Psychological defense being broken" },
      "CPU": { zh: "æ‡µäº†ã€å¤§è„‘åœæ­¢è¿è½¬", en: "Confused, brain stopped working" },
      "æ “Q": { zh: "Thank youçš„éŸ³è¯‘ï¼Œå¸¸è¡¨ç¤ºæ— è¯­", en: "Phonetic translation of 'Thank you', often expressing speechlessness" },
      "å†¤ç§": { zh: "å€’éœ‰è›‹ã€å§”å±ˆçš„äºº", en: "Unlucky person, someone who feels wronged" },
      "æ˜¾çœ¼åŒ…": { zh: "å–œæ¬¢å¼•äººæ³¨ç›®çš„äºº", en: "Someone who likes to attract attention" },
      "å°é•‡åšé¢˜å®¶": { zh: "å‡ºèº«å°é•‡ã€æ“…é•¿è€ƒè¯•ä½†ç¼ºä¹è§†é‡çš„å­¦ç”Ÿ", en: "Students from small towns who are good at exams but lack vision" },
      "ç‰¹ç§å…µå¼æ—…æ¸¸": { zh: "ç”¨æœ€å°‘æ—¶é—´æ¸¸è§ˆæœ€å¤šæ™¯ç‚¹", en: "Visiting as many attractions as possible in the shortest time" },
      "iäºº": { zh: "å†…å‘çš„äºº", en: "Introverted person" },
      "eäºº": { zh: "å¤–å‘çš„äºº", en: "Extroverted person" },
      "yyds": { zh: "æ°¸è¿œçš„ç¥ï¼ˆè¶…çº§æ£’ï¼‰", en: "Forever God (super awesome)" },
      "nsdd": { zh: "ä½ è¯´å¾—å¯¹ï¼ˆè¡¨ç¤ºèµåŒï¼‰", en: "You are right (express agreement)" },
      "xswl": { zh: "ç¬‘æ­»æˆ‘äº†ï¼ˆéå¸¸å¥½ç¬‘ï¼‰", en: "Laughing my head off (very funny)" },
      "u1s1": { zh: "æœ‰ä¸€è¯´ä¸€ï¼ˆå®è¯å®è¯´ï¼‰", en: "To be honest (speaking truthfully)" },
      "bdjw": { zh: "ä¸æ‡‚å°±é—®ï¼ˆä¸æ¸…æ¥šå°±é—®ï¼‰", en: "If you don't understand, just ask" },
      "awsl": { zh: "å•Šæˆ‘æ­»äº†ï¼ˆå¤ªå¯çˆ±äº†ï¼‰", en: "Ah, I'm dead (too cute)" },
      "zqsg": { zh: "çœŸæƒ…å®æ„Ÿï¼ˆçœŸè¯šçš„æ„Ÿæƒ…ï¼‰", en: "True feelings (sincere emotions)" },
      "dbq": { zh: "å¯¹ä¸èµ·", en: "Sorry" },
      "ky": { zh: "ä¸ä¼šçœ‹æ°”æ°›ï¼ˆæ—¥è¯­ç©ºæ°—èª­ã‚ãªã„ï¼‰", en: "Can't read the atmosphere" },
      "PUA": { zh: "ç²¾ç¥æ§åˆ¶å’Œæ“æ§", en: "Mental manipulation and control" },
      "è‰": { zh: "ç¬‘ï¼ˆæºè‡ª'è‰ç”Ÿãˆã‚‹'ï¼‰", en: "Laugh (from Japanese 'grass growing')" },
      "ç»ç»å­": { zh: "å¤ªç»äº†ã€å¤ªå‰å®³äº†", en: "Too amazing, too awesome" },
      "ootd": { zh: "ä»Šæ—¥ç©¿æ­ï¼ˆoutfit of the dayï¼‰", en: "Outfit of the day" },
      "dddd": { zh: "æ‡‚çš„éƒ½æ‡‚", en: "Those who know, know" },
      "æ±‚é”¤å¾—é”¤": { zh: "è¦æ±‚è¯æ®ç„¶åçœŸçš„å¾—åˆ°è¯æ®", en: "Asking for evidence and actually getting it" },
      "çœŸé¦™": { zh: "ä¹‹å‰æ‹’ç»ä½†åæ¥æ¥å—", en: "Previously refused but later accepted" },
      "æŸ æª¬ç²¾": { zh: "å–œæ¬¢é…¸åˆ«äººã€å«‰å¦’çš„äºº", en: "Someone who likes to be sour/jealous of others" },
      "å·¥å…·äºº": { zh: "åªè¢«å½“ä½œå·¥å…·ä½¿ç”¨çš„äºº", en: "Someone who is only used as a tool" },
      "ç²¾ç¥å°ä¼™": { zh: "å–œæ¬¢ç‚«é…·æ‰“æ‰®çš„å¹´è½»ç”·å­", en: "Young men who like to dress flashy and cool" },
      "é›†ç¾": { zh: "å§å¦¹ï¼ˆsistersçš„éŸ³è¯‘ï¼‰", en: "Sisters (phonetic translation)" },
      "è€é“": { zh: "å¥½æœ‹å‹ã€è€å…„å¼Ÿ", en: "Good friend, old buddy" },
      "å®‰æ’": { zh: "å¤„ç†ã€æå®š", en: "Handle, get it done" },
      "ç›˜": { zh: "ç©ã€æ‘†å¼„", en: "Play with, fiddle with" },
      "æ…•äº†": { zh: "ç¾¡æ…•äº†", en: "Envious" },
      "é…¸äº†": { zh: "å«‰å¦’äº†", en: "Jealous" },
      "çˆ·é’å›": { zh: "çˆ·çš„é’æ˜¥å›æ¥äº†", en: "My youth is back" },
      "çˆ·é’ç»“": { zh: "çˆ·çš„é’æ˜¥ç»“æŸäº†", en: "My youth is over" },
      "æ·¦": { zh: "å¹²çš„è°éŸ³ï¼Œè¡¨ç¤ºæ— å¥ˆ", en: "Homophone of 'damn', expressing helplessness" },
      "å¥¥åˆ©ç»™": { zh: "ç»™åŠ›çš„å€’è¿‡æ¥ï¼ŒåŠ æ²¹", en: "'Awesome' reversed, meaning 'come on'" },
      "èŠ­æ¯”Q": { zh: "å®Œäº†ã€ç³Ÿç³•ï¼ˆbarbecueéŸ³è¯‘ï¼‰", en: "Finished, bad (phonetic of 'barbecue')" },
      "åŒæ ‡": { zh: "åŒé‡æ ‡å‡†", en: "Double standards" },
      "å‡¡å°”èµ›": { zh: "ä½è°ƒç‚«å¯Œ", en: "Humble bragging" },
      "çˆ¬å±±": { zh: "çº¦ä¼šã€è°ˆæ‹çˆ±", en: "Dating, being in a relationship" },
      "æé’±": { zh: "èµšé’±ã€å·¥ä½œ", en: "Making money, working" },
      "ä¸Šç­äºº": { zh: "æ‰“å·¥äººã€ä¸Šç­æ—", en: "Office worker, working person" },
      "æ€¼": { zh: "é¡¶æ’ã€å›å˜´", en: "Talk back, retort" },
      "é©¬ç”²": { zh: "ç”¨å¤šä¸ªå°å·å‘å¸–æˆ–è¯´è¯", en: "Using multiple accounts to post or talk" },
      "çŒæ°´": { zh: "å‘å¾ˆå¤šæ²¡å†…å®¹çš„å¸–å­", en: "Posting many meaningless posts" },
      "233": { zh: "å¤§ç¬‘", en: "Laughing loudly" },
      "666": { zh: "å‰å®³ã€ç‰›é€¼", en: "Awesome, amazing" },
      "520": { zh: "æˆ‘çˆ±ä½ ", en: "I love you" },
      "886": { zh: "æ‹œæ‹œäº†", en: "Bye bye" },
      "3Q": { zh: "è°¢è°¢ï¼ˆThank youï¼‰", en: "Thank you" },
      "GG": { zh: "å“¥å“¥æˆ–å®Œäº†ï¼ˆGood Gameï¼‰", en: "Brother or game over" },
      "MM": { zh: "ç¾çœ‰ã€ç¾å¥³", en: "Pretty girl, beauty" }
    };

    // æ–‡æœ¬èµ„æº
    const i18n = {
      zh: {
        mainTitle: "ç½‘ç»œè¯­/Emoji è§£é‡Šå™¨",
        langBtn: "English",
        inputPlaceholder: "è¾“å…¥ç½‘ç»œè¯­å¥ï¼Œæ¯”å¦‚ï¼šä»Šå¤©çœŸæ˜¯å¤ªemoäº†ğŸ˜­ï¼",
        explainBtn: "è§£é‡Šç½‘ç»œè¯­",
        resultTitle: "ç¿»è¯‘ç»“æœï¼š",
        addTermTitle: "æ·»åŠ æ–°è¯æ¡",
        labelNewTerm: "æ–°è¯è¯­ (è¯è¯­/ç¬¦å·):",
        labelZh: "ä¸­æ–‡è§£é‡Š:",
        labelEn: "è‹±æ–‡è§£é‡Š:",
        addTermBtn: "æ·»åŠ è¯æ¡",
        placeholderNewTerm: "ä¾‹å¦‚ï¼šğŸ˜‚",
        placeholderZh: "ä¾‹å¦‚ï¼šç¬‘åˆ°å“­",
        placeholderEn: "ä¾‹å¦‚ï¼šLaughing until crying",
        addTermMsgOK: term => `è¯æ¡ "${term}" æ·»åŠ æˆåŠŸï¼`,
        addTermMsgEmptyTerm: "è¯·è¾“å…¥æ–°è¯è¯­ã€‚",
        addTermMsgEmptyZh: "è¯·è¾“å…¥ä¸­æ–‡è§£é‡Šã€‚",
        addTermMsgEmptyEn: "è¯·è¾“å…¥è‹±æ–‡è§£é‡Šã€‚"
      },
      en: {
        mainTitle: "Slang/Emoji Explainer",
        langBtn: "ä¸­æ–‡",
        inputPlaceholder: "Enter sentences with slang or emoji, e.g.: Today I'm so emoğŸ˜­!",
        explainBtn: "Explain Slang",
        resultTitle: "Explanation:",
        addTermTitle: "Add New Term",
        labelNewTerm: "New Term (word/symbol):",
        labelZh: "Chinese Explanation:",
        labelEn: "English Explanation:",
        addTermBtn: "Add Term",
        placeholderNewTerm: "e.g.: ğŸ˜‚",
        placeholderZh: "e.g.: ç¬‘åˆ°å“­",
        placeholderEn: "e.g.: Laughing until crying",
        addTermMsgOK: term => `Term "${term}" added successfully!`,
        addTermMsgEmptyTerm: "Please enter a new term.",
        addTermMsgEmptyZh: "Please enter the Chinese explanation.",
        addTermMsgEmptyEn: "Please enter the English explanation."
      }
    };

    function updateLangUI() {
      const lang = currentLang;
      document.getElementById('mainTitle').textContent = i18n[lang].mainTitle;
      document.getElementById('langBtn').textContent = i18n[lang].langBtn;
      document.getElementById('input').placeholder = i18n[lang].inputPlaceholder;
      document.getElementById('explainBtn').textContent = i18n[lang].explainBtn;
      document.getElementById('resultTitle').textContent = i18n[lang].resultTitle;
      document.getElementById('addTermTitle').textContent = i18n[lang].addTermTitle;
      document.getElementById('labelNewTerm').textContent = i18n[lang].labelNewTerm;
      document.getElementById('labelZh').textContent = i18n[lang].labelZh;
      document.getElementById('labelEn').textContent = i18n[lang].labelEn;
      document.getElementById('addTermBtn').textContent = i18n[lang].addTermBtn;
      document.getElementById('newTerm').placeholder = i18n[lang].placeholderNewTerm;
      document.getElementById('newExplanationZh').placeholder = i18n[lang].placeholderZh;
      document.getElementById('newExplanationEn').placeholder = i18n[lang].placeholderEn;
      // Also clear addTermMessage
      document.getElementById('addTermMessage').textContent = '';
    }

    const langBtn = document.getElementById('langBtn');
    langBtn.addEventListener('click', () => {
      if (currentLang === 'zh') {
        currentLang = 'en';
      } else {
        currentLang = 'zh';
      }
      updateLangUI();
      translateText();
    });

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function translateText() {
      const inputText = document.getElementById("input").value;
      const inputArray = Array.from(inputText); // emoji-safe split
      const keys = Object.keys(slangDict).sort((a, b) => b.length - a.length);
      let result = "";
      let i = 0;
      while (i < inputArray.length) {
        let matched = false;
        for (const term of keys) {
          const termArray = Array.from(term);
          const segment = inputArray.slice(i, i + termArray.length).join('');
          if (segment.toLowerCase() === term.toLowerCase()) {
            const explanation = slangDict[term.toLowerCase()]?.[currentLang];
            const safeExplanation = explanation ? explanation.replace(/"/g, '&quot;').replace(/'/g, '&#x27;') : "";
            const tooltipHTML = `<span class='tooltip' data-explanation="${encodeURIComponent(explanation)}" tabindex="0">${segment}</span>`;
            result += tooltipHTML;
            i += termArray.length;
            matched = true;
            break;
          }
        }
        if (!matched) {
          result += inputArray[i];
          i++;
        }
      }
      document.getElementById("output").innerHTML = result;
      bindTooltipClick();
    }

    // å¼¹çª—è§£é‡Šæ¡†
    function showExplainBox(explanation, anchorElem) {
      // ç§»é™¤å·²æœ‰å¼¹çª—
      removeExplainBox();
      
      const box = document.createElement('div');
      box.className = 'tooltip-explain-box';
      box.innerHTML = `<button class="close-btn" title="å…³é—­" aria-label="å…³é—­">&times;</button><div style="padding-top:1.2em;">${explanation}</div>`;
      document.body.appendChild(box);
      
      // è·å–é”šç‚¹å…ƒç´ çš„ä½ç½®ä¿¡æ¯
      const rect = anchorElem.getBoundingClientRect();
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
      
      // ä¸´æ—¶æ˜¾ç¤ºä»¥è·å–å¼¹çª—å°ºå¯¸
      box.style.visibility = 'hidden';
      box.style.display = 'block';
      const boxRect = box.getBoundingClientRect();
      
      // è®¡ç®—å¼¹çª—ä½ç½®ï¼ˆæ˜¾ç¤ºåœ¨å…ƒç´ ä¸Šæ–¹ï¼‰
      let left = rect.left + scrollLeft + (rect.width / 2) - (boxRect.width / 2);
      let top = rect.top + scrollTop - boxRect.height - 8; // 8px é—´è·
      
      // ç¡®ä¿å¼¹çª—ä¸ä¼šè¶…å‡ºè§†çª—è¾¹ç•Œ
      const viewportWidth = window.innerWidth;
      const margin = 10;
      
      if (left < margin) {
        left = margin;
      } else if (left + boxRect.width > viewportWidth - margin) {
        left = viewportWidth - boxRect.width - margin;
      }
      
      // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
      if (top < scrollTop + margin) {
        top = rect.bottom + scrollTop + 8;
        // ç§»é™¤ä¸‹ä¸‰è§’å½¢ï¼Œæ·»åŠ ä¸Šä¸‰è§’å½¢
        box.style.setProperty('--arrow-direction', 'up');
        box.classList.add('tooltip-below');
      }
      
      // è®¾ç½®æœ€ç»ˆä½ç½®å¹¶æ˜¾ç¤º
      box.style.left = left + 'px';
      box.style.top = top + 'px';
      box.style.visibility = 'visible';
      
      // å…³é—­äº‹ä»¶
      const closeBtn = box.querySelector('.close-btn');
      closeBtn.addEventListener('click', removeExplainBox);
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­
      function clickOutsideHandler(e) {
        if (!box.contains(e.target) && !anchorElem.contains(e.target)) {
          removeExplainBox();
        }
      }
      
      // ESCå…³é—­
      function escHandler(e) {
        if (e.key === 'Escape') {
          removeExplainBox();
        }
      }
      
      // å»¶è¿Ÿæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…ç«‹å³è§¦å‘
      setTimeout(() => {
        document.addEventListener('click', clickOutsideHandler);
        document.addEventListener('keydown', escHandler);
      }, 100);
      
      // å­˜å‚¨ç§»é™¤å‡½æ•°ä»¥ä¾¿æ¸…ç†
      box.removeHandler = function() {
        document.removeEventListener('click', clickOutsideHandler);
        document.removeEventListener('keydown', escHandler);
      };
    }

    function removeExplainBox() {
      const box = document.querySelector('.tooltip-explain-box');
      if (box) {
        if (box.removeHandler) {
          box.removeHandler();
        }
        if (box.parentNode) {
          box.parentNode.removeChild(box);
        }
      }
    }

    function bindTooltipClick() {
      // å…ˆç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
      const tooltips = document.querySelectorAll('#output .tooltip');
      tooltips.forEach(el => {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        el.onclick = null;
        el.onkeydown = null;
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        el.addEventListener('click', function(e) {
          e.stopPropagation();
          const explanation = decodeURIComponent(this.getAttribute('data-explanation'));
          showExplainBox(explanation, this);
        });
        
        // é”®ç›˜å¯è®¿é—®
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });
    }

    // Handle add term form submission
    const addTermForm = document.getElementById('addTermForm');
    const addTermMessage = document.getElementById('addTermMessage');

    // Supabase client initialization
    const supabase = window.supabase.createClient(
      "https://fqpnbiprehoglqrkhzui.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxcG5iaXByZWhvZ2xxcmtoenVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzQ2NjQsImV4cCI6MjA2Njk1MDY2NH0.aFZmiUC0oSYWiKtbVAzQ_6iW4DjYFnSIzIWABdr5HDs"
    );

    addTermForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const lang = currentLang;
      const newTerm = document.getElementById('newTerm').value.trim();
      const newExplanationZh = document.getElementById('newExplanationZh').value.trim();
      const newExplanationEn = document.getElementById('newExplanationEn').value.trim();

      if (!newTerm) {
        addTermMessage.style.color = 'red';
        addTermMessage.textContent = i18n[lang].addTermMsgEmptyTerm;
        return;
      }
      if (!newExplanationZh) {
        addTermMessage.style.color = 'red';
        addTermMessage.textContent = i18n[lang].addTermMsgEmptyZh;
        return;
      }
      if (!newExplanationEn) {
        addTermMessage.style.color = 'red';
        addTermMessage.textContent = i18n[lang].addTermMsgEmptyEn;
        return;
      }

      const termLower = newTerm.toLowerCase();
      slangDict[termLower] = { zh: newExplanationZh, en: newExplanationEn };

      const success = await saveSlangDict(newTerm, newExplanationZh, newExplanationEn);
      if (!success) {
        addTermMessage.style.color = 'red';
        addTermMessage.textContent = 'ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
        return;
      }

      addTermMessage.style.color = '#1ca51c';
      addTermMessage.textContent = i18n[lang].addTermMsgOK(newTerm);

      addTermForm.reset();
      await loadSlangDict();
      translateText();
    });

    // Supabase: æ‹‰å–è¯å…¸
    async function loadSlangDict() {
      const { data, error } = await supabase.from("slang_terms").select("*");
      if (error) {
        console.error("åŠ è½½è¯å…¸å¤±è´¥", error);
        updateLangUI();
        return;
      }
      data.forEach(item => {
        slangDict[item.term] = { zh: item.zh, en: item.en };
      });
      updateLangUI();
      translateText();
    }

    // Supabase: ä¿å­˜/æ›´æ–°è¯æ¡
    async function saveSlangDict(term, zh, en) {
      const { error } = await supabase.from("slang_terms").upsert([
        { term, zh, en }
      ]);
      if (error) {
        console.error("ä¿å­˜å¤±è´¥", error);
        return false;
      }
      return true;
    }

    // åˆå§‹åŠ è½½
    loadSlangDict();
  </script>
</body>
</html>